---
title: "Oscar Predictions Walkthrough"
author: "Peter Zanca"
date: "January 30, 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## The Google News Model

* Create a csv with each nominee's name (and actor's character)
* Create the URL for each search you need to run:
* Sample: https://www.google.com/search?&tbm=nws&q=joaquin+phoenix+arthur+fleck+Oscars
    + Part 1: https://www.google.com/search?&tbm=nws&q=
    + Part 2: Actor's name with spaces replaced by +
    + Part 3: +
    + Part 4: Character's name with spaces replaced by +
    + Part 5: +Oscars
* Loop through those pages and "scrape" the results element


```{r eval =FALSE}
library(tidyverse)
library(rvest)
library(RSelenium)

#Set up the RSelenium driver.
driver <- rsDriver(browser = c("chrome"),chromever ="79.0.3945.36", port = 4444L)
remDr <- driver[["client"]]

#Import the CSV into a dataframe and create a blank column for the search results.
oscars2020 <- read_csv("oscars2020.csv") %>%
  mutate(result_count = NA_character_)

#Loop through each nominee in the dataframe
for (nominee in 1:nrow(oscars2020)) {
  
    #Create the URL using the nominee name and secondary field (if applicable)
    url <- paste0("https://www.google.com/search?&tbm=nws&q=",
                  str_replace(oscars2020$nominee_name[nominee], " ", "+"), "+",
                  ifelse(oscars2020$second_term[nominee] == 1,
                         paste0(str_replace(oscars2020$character_name[nominee], " ", "+"), "+"),
                         ""),
                  "oscars")
    
    #Send RSelenium to the page
    remDr$navigate(url)
    
    #Extract the HTML from the page
    html <- remDr$getPageSource()[[1]]
    html <- read_html(html)

    #Extract the "Results Stats" from the page
    result_count <- html %>%
      html_nodes("#resultStats") %>%
      html_text()
    
    #Add the stats to that row of the dataframe.
    oscars2020$result_count[nominee] <- result_count
  
}

#After you've scraped all the rows, clean up the result.
oscars2020 <- oscars2020 %>%
  mutate(result_count = str_extract(result_count, "(?<=About ).*(?= results)"),
         result_count = str_remove_all(result_count, ","),
         result_count = as.numeric(result_count))

#Take the top results getter for each award.
top_results <- oscars2020 %>%
  group_by(award) %>%
  top_n(result_count, n = 1)
```

## The 538 Model

Listed below are the awards included in 538's model. We'll try to scrape as many as we can from IMDb.

__CRITICS__

* Golden Globes
* Critics' Choice Movie Awards
* Chicago Film Critics Association awards
* Satellite Awards
* National Board of Review awards
* New York Film Critics Circle awards
* Los Angeles Film Critics Circle awards

__INSIDERS__

* Directors Guild of America
* Producers Guild of America
* Screen Actors Guild
* Writers Guild of America
* British Academy of Film and Television Arts (BAFTA)
* American Cinema Editors

```{r eval =FALSE}

library(tidyverse)
library(rvest)
library(RSelenium)

#I use the following line to set up a working drive on my Google Drive, but you can use whatever drive you like, or read/write files directly to paths you specify in subsequent lines of code.
setwd("C:\\Users\\peter\\Google Drive\\Business Analytics Club\\Oscars Predictions")

#Read in the list of award shows and their IMDb URLs.
award_show_list <- read_csv("award_show_list.csv")

#Set up the RSelenium driver. This will launch a Chrome web browser in another window.
#If you don't use Chrome, we'll need to adjust the code below to your preferred web browser.
driver <- rsDriver(browser = c("chrome"),chromever ="79.0.3945.36", port = 4445L)
remDr <- driver[["client"]]

#Create an empty data frame where we can store our awards as we scrape them.
awards_all <- data.frame()

#Loop through each award show in the award_show_list dataframe.
for (award_show in 1:nrow(award_show_list)) {
  
  #Create variables with the award show's name and URL.
  award_show_name <- award_show_list$award_show[award_show]
  award_show_url <- award_show_list$url[award_show]

  #Have RSelenium navigate to the award show's URL.
  remDr$navigate(award_show_url)
  #Extract the page's HTML (using RSelenium)
  html <- remDr$getPageSource()[[1]]
  #Use rvest to read in the HTML.
  html <- read_html(html)
  
  #Use rvest to select the award history section and extract the years, then convert them to numbers.
  award_years <- html %>%
    html_nodes(".event-history-widget a") %>%
    html_text() %>%
    as.numeric()
  
  #Use rvest to select the award history section and extract the hyperlink URL (denoted by "href") for each year.
  award_urls <- html %>%
    html_nodes(".event-history-widget a") %>%
    html_attr("href")
  
  #Create a dataframe of each year's URL by combining the years and URLs.
  award_url_df <- data.frame(award_years, award_urls, stringsAsFactors = FALSE)
  
  #Set up a "Reference Year" variable that should help us match years up later.
  ref_year <- 1
  #Set up a "Row Number" variable that will help us move through the next loop.
  row_num <- 1
  
  #Create a while loop that runs as long as the "Reference Year" is less than or equal to 25 (i.e. we're only going back 25 years)
  #OR the "Row Number" reaches the end of the list of URLs (i.e. the last year for which IMDb has a page).
  while (ref_year <= 25 & row_num <= nrow(award_url_df)) {
    
    #Set up variables for the year and the URL for that award and year
    url <- paste0("https://www.imdb.com", award_url_df$award_urls[row_num])
    year <- award_url_df$award_years[row_num]
    
    #Have RSelenium navigate to that URL.
    remDr$navigate(url)
    
    #Extract the HTML using RSelenium
    html <- remDr$getPageSource()[[1]]
    #Use rvest to read the HTML.
    html <- read_html(html)
    
    #Count the number of award categories and then subtract the number of award names and then add one.
    #It's hard to explain, but this gives us a count of the awards without including things like lifetime achievement awards.
    number_of_awards <- html %>%
      html_nodes(".event-widgets__award-category") %>%
      length() - 
      html %>%
      html_nodes(".event-widgets__award-name") %>%
      length() +
      1
    
    #If there is more than one award listed on the page, proceed with the following code to scrape the page.
    #(We do this because IMDb has award pages for some years that are just blank. We use this IF statement to skip those.)
    if (number_of_awards > 1) {
      
      #Loop through each award in the list of award categories
      for (award in 1:number_of_awards) {
        
        #Use rvest to extract the name of the award ("BEST PICTURE")
        award_name <- html %>%
          html_nodes(".event-widgets__award-category") %>%
          .[[award]] %>%
          html_nodes(".event-widgets__award-category-name") %>%
          html_text()
        
        #Use rvest to extract the name of the nominee (the actor or the film)
        nominees <- html %>%
          html_nodes(".event-widgets__award-category") %>%
          .[[award]] %>%
          html_nodes(".event-widgets__primary-nominees") %>%
          html_text()
        
        #Use rvest to extract the second item listed for the nominee (for actors, the name of the film)
        details <- html %>%
          html_nodes(".event-widgets__award-category") %>%
          .[[award]] %>%
          html_nodes(".event-widgets__secondary-nominees") %>%
          html_text()
        
        #Create a temporary dataframe that combines the nominees and their details with the award show's name, the award's name, the year, the "Reference Year" variable, and whether or not they won.
        #NOTE: On IMDb, the first person listed is the winner, so the ifelse statement below captures this.
        temp_df <- data.frame(nominees, details, stringsAsFactors = FALSE) %>%
          mutate(award_show = award_show_name,
                 year = year,
                 award = award_name,
                 winner = ifelse(row_number() == 1, 1, 0),
                 ref_year = ref_year)
        
        #Add the temporary dataframe to the container capturing all of the award show data.
        awards_all <- rbind(awards_all,
                            temp_df)
        
      }
      
      #Increase the "Reference Year" and "Row Number" variables by 1 and continue the WHILE loop.
      ref_year <- ref_year + 1
      row_num <- row_num + 1
      
    } else {
      
      #Going back to the IF statement above... If there is not more than 1 award on the page, increase the "Row Number" variable by 1 and continue the WHILE loop.
      row_num <- row_num + 1
      
    }
    
  }
 
}

```
